# langchain_core.documents
from typing import Any, Optional, Sequence
from sentence_transformers import CrossEncoder
from langchain_core.documents import Document
import torch
from transformers import AutoModelForSequenceClassification, AutoTokenizer, BatchEncoding, PreTrainedTokenizerFast

class Document:
    def __init__(self, page_content: str, metadata: dict):
        self.page_content = page_content
        self.metadata = metadata


def rerank_documents(query: str, documents: Sequence[Document],
                    top_n: int = 4, device: str = "cuda",
                    max_length: int = 1024, batch_size: int = 32,
                    num_workers: int = 0) -> Sequence[Document]:

    reranker_model_path = '/home/pc/PycharmProjects/chat0.2.4/bge-reranker-large'
    model = CrossEncoder(model_name=reranker_model_path, max_length=1024, device=device)
    print(documents)
    if not documents:
        return []

    doc_list = list(documents)
    _docs = [d.page_content for d in doc_list]

    sentence_pairs = [[query, _doc] for _doc in _docs]

    results = model.predict(sentences=sentence_pairs, batch_size=batch_size,
                            num_workers=num_workers, convert_to_tensor=True)

    top_k = min(top_n, len(results))
    values, indices = results.topk(top_k)

    final_results = []
    for value, index in zip(values, indices):
        doc = doc_list[index]
        doc.metadata["relevance_score"] = value
        final_results.append(doc)

    return final_results


# Sample Document instances
doc1 = Document(page_content="第一千零六十二条\u3000夫妻在婚姻关系存续期间所得的下列财产，为夫妻的共同财产，归夫妻共同所有：\n\n（一）工资、奖金、劳务报酬；\n\n（二）生产、经营、投资的收益；\n\n（三）知识产权的收益；\n\n（四）继承或者受赠的财产，但是本法第一千零六十三条第三项规定的除外；\n\n（五）其他应当归共同所有的财产。\n\n夫妻对共同财产，有平等的处理权。", metadata={"key": "value1"})
#doc2 = Document(page_content="根据《民法典》第一千零六十二条之规定，我国实行婚内夫妻财产共有制，且夫妻对共同财产有平等的处理权。配偶一方向第三者赠与财产，显然超出了日常生活需要，属于对夫妻共同财产的擅自处分，不仅损害了配偶一方合法的财产权益，且该赠与行为违反了夫妻间的忠实义务，有悖公序良俗，故该赠与行为无效。需要注意的是，赠与行为全部无效而非部分无效，故配偶一方可主张要求第三人返还全部受赠财产。根据《最高人民法院关于适用<中华人民共和国民法典>婚姻家庭编的解释（一）》第四十九条之规定，抚养费的数额，需综合考虑三个方面，即子女的实际需要、父母双方的负担能力和当地的实际生活水平。有固定收入的，抚养费一般可以按其月总收入的百分之二十至三十的比例给付。负担两个以上子女抚养费的，比例可以适当提高，但一般不得超过月总收入的百分之五十。无固定收入的，抚养费的数额可以依据当年总收入或者同行业平均收入，参照上述比例确定。有特殊情况的，可以适当提高或者降低上述比例。需注意的是，抚养费并非直接根据非直接抚养一方工资收入的百分之二十至三十的比例给付，收入情况只是确定抚养费数额的其中一个参考因素，还需要结合子女的实际需要以及当地生活水平确定。目前浙江省范围内，法院判决的抚养费一般在1000元至3000元不等，不同地区法院存在差异。根据《民法典》第一千零六十二条之规定，我国实行婚内夫妻财产共有制，且夫妻对共同财产有平等的处理权。配偶一方向第三者赠与财产，显然超出了日常生活需要，属于对夫妻共同财产的擅自处分，不仅损害了配偶一方合法的财产权益，且该赠与行为违反了夫妻间的忠实义务，有悖公序良俗，故该赠与行为无效。需要注意的是，赠与行为全部无效而非部分无效，故配偶一方可主张要求第三人返还全部受赠财产。根据《最高人民法院关于适用<中华人民共和国民法典>婚姻家庭编的解释（一）》第四十九条之规定，抚养费的数额，需综合考虑三个方面，即子女的实际需要、父母双方的负担能力和当地的实际生活水平。有固定收入的，抚养费一般可以按其月总收入的百分之二十至三十的比例给付。负担两个以上子女抚养费的，比例可以适当提高，但一般不得超过月总收入的百分之五十。无固定收入的，抚养费的数额可以依据当年总收入或者同行业平均收入，参照上述比例确定。有特殊情况的，可以适当提高或者降低上述比例。需注意的是，抚养费并非直接根据非直接抚养一方工资收入的百分之二十至三十的比例给付，收入情况只是确定抚养费数额的其中一个参考因素，还需要结合子女的实际需要以及当地生活水平确定。目前浙江省范围内，法院判决的抚养费一般在1000元至3000元不等，不同地区法院存在差异。第一千零六十三条\u3000下列财产为夫妻一方的个人财产：\n\n（一）一方的婚前财产；\n\n（二）一方因受到人身损害获得的赔偿或者补偿；\n\n（三）遗嘱或者赠与合同中确定只归一方的财产；\n\n（四）一方专用的生活用品；\n\n（五）其他应当归一方的财产。", metadata={"key": "value2"})
doc3 = Document(page_content="第一千零六十五条\u3000男女双方可以约定婚姻关系存续期间所得的财产以及婚前财产归各自所有、共同所有或者部分各自所有、部分共同所有。约定应当采用书面形式。没有约定或者约定不明确的，适用本法第一千零六十二条、第一千零六十三条的规定。\n\n夫妻对婚姻关系存续期间所得的财产以及婚前财产的约定，对双方具有法律约束力。\n\n夫妻对婚姻关系存续期间所得的财产约定归各自所有，夫或者妻一方对外所负的债务，相对人知道该约定的，以夫或者妻一方的个人财产清偿。", metadata={"key": "value3"})
doc4 = Document(page_content="妻在婚姻关系存续期间所得的下列财产，归夫妻共同有：\n\n（一）工资、奖金、劳务报酬；\n\n（二）生产、经营、投资的收益；\n\n（三）知识产权的收益；\n\n（四）继承或者受赠的财产，但是本法第一千零六十三条第三项规定的除外；\n\n（五）其他应当归共同所有的财产。\n\n夫妻对共同财产，有平等的处理权。下列财产为夫妻一方的个人财产：\n\n（一）一方的婚前财产；\n\n（二）一方因受到人身损害获得的赔偿或者补偿；\n\n（三）遗嘱或者赠与合同中确定只归一方的财产；\n\n（四）一方专用的生活用品；\n\n（五）其他应当归一方的财产。", metadata={"key": "value1"})
doc5 = Document(page_content="第七十二条\u3000夫妻双方分割共同财产中的股票、债券、投资基金份额等有价证券以及未上市股份有限公司股份时，协商不成或者按市价分配有困难的，人民法院可以根据数量按比例分配。第七十二条\u3000夫妻双方分割共同财产中的股票、债券、投资基金份额等有价证券以及未上市股份有限公司股份时，协商不成或者按市价分配有困难的，人民法院可以根据数量按比例分配。第七十二条\u3000夫妻双方分割共同财产中的股票、债券、投资基金份额等有价证券以及未上市股份有限公司股份时，协商不成或者按市价分配有困难的，人民法院可以根据数量按比例分配。、共同所有或者部分各自所有、部分共同所有。约定应当采用书面形式。没有约定或者约定不明确的，适用本法第一千零六十二条、第一千零六十三条的规定。\n\n夫妻对婚姻关系存续期间所得的财产以及婚前财产的约定，对双方具有法律约束力。\n\n夫妻对婚姻关系存续期间所得的财产约定归各自所有，夫或者妻一方对外所负的债务，相对人知道该约定的，以夫或者妻一方的个人财产清偿。", metadata={"key": "value3"})
doc6 = Document(page_content="根据《最高人民法院关于适用<中华人民共和国民法典>婚姻家庭编的解释（一）》第七十八条之规定：夫妻一方婚前签订不动产买卖合同，以个人财产支付首付款并在银行贷款，婚后用夫妻共同财产还贷，不动产登记于首付款支付方名下的，离婚时该不动产由双方协议处理。依前款规定不能达成协议的，人民法院可以判决该不动产归登记一方，尚未归还的贷款为不动产登记一方的个人债务。双方婚后共同还贷支付的款项及其相对应财产增值部分，离婚时应根据照顾子女、女方和无过错方权益的原则，由不动产登记一方对另一方进行补偿。至于补偿的数额，浙江省高级人民法院在《关于审理婚姻家庭案件若干问题的解答》中规定可以按以下公式计算：[婚后还贷本息总额÷（购买时房价+应还贷款利息总额）]×离婚时房价÷2。如在个案中，计算所得补偿数额明显低于婚后还贷本息总额的一半，应在上述计算方式的基础上，根据照顾子女和女方利益的原则，结合案件实际合理确定补偿数额。", metadata={"key": "value1"})
doc7 = Document(page_content="根据《民法典》第一千零六十二条之规定，我国实行婚内夫妻财产共有制，且夫妻对共同财产有平等的处理权。配偶一方向第三者赠与财产，显然超出了日常生活需要，属于对夫妻共同财产的擅自处分，不仅损害了配偶一方合法的财产权益，且该赠与行为违反了夫妻间的忠实义务，有悖公序良俗，故该赠与行为无效。需要注意的是，赠与行为全部无效而非部分无效，故配偶一方可主张要求第三人返还全部受赠财产。根据《最高人民法院关于适用<中华人民共和国民法典>婚姻家庭编的解释（一）》第四十九条之规定，抚养费的数额，需综合考虑三个方面，即子女的实际需要、父母双方的负担能力和当地的实际生活水平。有固定收入的，抚养费一般可以按其月总收入的百分之二十至三十的比例给付。负担两个以上子女抚养费的，比例可以适当提高，但一般不得超过月总收入的百分之五十。无固定收入的，抚养费的数额可以依据当年总收入或者同行业平均收入，参照上述比例确定。有特殊情况的，可以适当提高或者降低上述比例。需注意的是，抚养费并非直接根据非直接抚养一方工资收入的百分之二十至三十的比例给付，收入情况只是确定抚养费数额的其中一个参考因素，还需要结合子女的实际需要以及当地生活水平确定。目前浙江省范围内，法院判决的抚养费一般在1000元至3000元不等，不同地区法院存在差异。", metadata={"key": "value2"})
doc8 = Document(page_content="根据《民法典》第一千零六十二条之规定，我国实行婚内夫妻财产共有制，且夫妻对共同财产有平等的处理权。配偶一方向第三者赠与财产，显然超出了日常生活需要，属于对夫妻共同财产的擅自处分，不仅损害了配偶一方合法的财产权益，且该赠与行为违反了夫妻间的忠实义务，有悖公序良俗，故该赠与行为无效。需要注意的是，赠与行为全部无效而非部分无效，故配偶一方可主张要求第三人返还全部受赠财产。根据《最高人民法院关于适用<中华人民共和国民法典>婚姻家庭编的解释（一）》第四十九条之规定，抚养费的数额，需综合考虑三个方面，即子女的实际需要、父母双方的负担能力和当地的实际生活水平。有固定收入的，抚养费一般可以按其月总收入的百分之二十至三十的比例给付。负担两个以上子女抚养费的，比例可以适当提高，但一般不得超过月总收入的百分之五十。无固定收入的，抚养费的数额可以依据当年总收入或者同行业平均收入，参照上述比例确定。有特殊情况的，可以适当提高或者降低上述比例。需注意的是，抚养费并非直接根据非直接抚养一方工资收入的百分之二十至三十的比例给付，收入情况只是确定抚养费数额的其中一个参考因素，还需要结合子女的实际需要以及当地生活水平确定。目前浙江省范围内，法院判决的抚养费一般在1000元至3000元不等，不同地区法院存在差异。", metadata={"key": "value2"})
# Query string
query = "夫妻共同财产有哪些"
#print(len(doc2.page_content))
# List of documents
documents = [doc1, doc3, doc4, doc5, doc6, doc7, doc8]

# Running the rerank_documents function
reranked_results = rerank_documents(query, documents, top_n=4, device="cuda", max_length=1024, batch_size=32, num_workers=0)

# Printing the reranked results
for result in reranked_results:
    print(f"Relevance Score: {result.metadata['relevance_score']}, Metadata: {result.metadata}")